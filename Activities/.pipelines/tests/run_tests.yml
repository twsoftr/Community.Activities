name: Run Integration Tests $(Date:yyyyMMdd)$(Rev:.r)

variables:
  - group: Secrets
  - name: azureServiceConnectionName
    value: 'AzureDevTest-EA'
  - name: aksResourcePrefix
    value: 'dvts-ts-ta-we'
  - name: sftpContainer
    value: 'sftpserver-deployment'
  - name: sqlserverContainer
    value: 'sqlserver-deployment'
  - name: uipathLicenseCode
    value: $(LicenseCode)
  - name: uipathVersion
    value: '20.10.4'
  - name: studioInstallPath
    value: 'd:\robot'
  - name: orchestratorPSModuleSourceUrl
    value: 'https://www.myget.org/F/uipath-dev/api/v2'
  - name: uipathTestDirectory
    value: 'd:\teste'
  - name: packagesFolder
    value: 'd:\teste\Packages'
  - name: javaBuildPipeline
    value: 1098
  - name: pythonBuildPipeline
    value: 1099
  - name: databaseBuildPipeline
    value: 1094
  - name: SQLServer_Connection
    value: "'Data Source=$($env:sqlPublicIP);User ID=sa;Password=b2298905Acfa%'"
  - name: SQLServer_db_provider
    value: "'System.Data.SqlClient'"

# use triggers only on specific branches(no *)
trigger:
  branches:
    include:
      - masters
      - develop
  paths:
    include:
      - Activities/*

# don't user PR triggers 
pr: none

stages:
#- stage: Run_Java
#  jobs:
#  - job: Run_Java_Integration_Tests
#    pool:
#      vmImage: 'windows-latest'
#    steps:
#    - template: steps/setup_env.yml
#      parameters:
#        uipathLicenseCode: $(uipathLicenseCode)
#        uipathVersion: $(uipathVersion)
#        studioInstallPath: $(studioInstallPath)
#        orchestratorPSModuleSourceUrl: $(orchestratorPSModuleSourceUrl)
#        uipathTestDirectory: $(uipathTestDirectory)
#
#    - template: steps/run_java.yml
#      parameters:
#        buildPipeline: ${{ variables.javaBuildPipeline }}
#        packagesFolder: $(packagesFolder)
#        studioInstallPath: $(studioInstallPath)
#        uipathTestDirectory: $(uipathTestDirectory)
#
#- stage: Run_Python
#  jobs:
#  - job: Run_Python_Integration_Tests
#    pool:
#      vmImage: 'windows-latest'
#    steps:
#    - template: steps/setup_env.yml
#      parameters:
#        uipathLicenseCode: $(uipathLicenseCode)
#        uipathVersion: $(uipathVersion)
#        studioInstallPath: $(studioInstallPath)
#        orchestratorPSModuleSourceUrl: $(orchestratorPSModuleSourceUrl)
#        uipathTestDirectory: $(uipathTestDirectory)
#
#    - template: steps/run_python.yml
#      parameters:
#        buildPipeline: ${{ variables.pythonBuildPipeline }}
#        packagesFolder: $(packagesFolder)
#        studioInstallPath: $(studioInstallPath)
#        uipathTestDirectory: $(uipathTestDirectory)


- stage: Run_SQL_Server
  jobs:
  - job: Run_SQL_Server_Integration_Tests
    pool:
      vmImage: 'windows-latest'
    steps:
    - template: steps/setup_env.yml
      parameters:
        uipathLicenseCode: $(uipathLicenseCode)
        uipathVersion: $(uipathVersion)
        studioInstallPath: $(studioInstallPath)
        orchestratorPSModuleSourceUrl: $(orchestratorPSModuleSourceUrl)
        uipathTestDirectory: $(uipathTestDirectory)

    - template: steps/setup_aks.yml
      parameters:
        azureServiceConnectionName: $(azureServiceConnectionName)
        aksResourcePrefix: $(aksResourcePrefix)
        sftpContainer: $(sftpContainer)
        sqlserverContainer: $(sqlserverContainer)
        deploySqlserverContainer: true

    - template: steps/run_sql.yml
      parameters:
        buildPipeline: ${{ variables.databaseBuildPipeline }}
        packagesFolder: $(packagesFolder)
        studioInstallPath: $(studioInstallPath)
        uipathTestDirectory: $(uipathTestDirectory)
        SQLServer_Connection: $(SQLServer_Connection)
        SQLServer_db_provider: $(SQLServer_db_provider)
 
    - template: steps/clean_aks.yml
      parameters:
        azureServiceConnectionName: $(azureServiceConnectionName)
        aksResourcePrefix: $(aksResourcePrefix)
        sftpContainer: $(sftpContainer)
        sqlserverContainer: $(sqlserverContainer)
        deploySqlserverContainer: true